<!doctype html>
<meta charset=utf-8>
<title>element-wise binary operations</title>
<link rel=help href=https://webmachinelearning.github.io/webnn/#api-neuralnetworkcontext-binary>
<script src=/resources/testharness.js></script>
<script src=/resources/testharnessreport.js></script>
<!-- <script src=/webnn/lib/numpy.js></script>
<script src=/webnn/utils.js></script> -->
<script src=/webnn/dist/webnn-polyfill.js></script>
<div id=log></div>
<script type="module">
  'use strict';
  import * as utils from '/webnn/utils.js';
  let builder;
  setup(() => {
    const context = navigator.ml.createContext();
    builder = new MLGraphBuilder(context);
  })
  
  function testReshape(oldShape, newShape, expectedShape) {
    
    const x = builder.input('x', {type: 'float32', dimensions: oldShape});
    const y = builder.reshape(x, newShape);
    const graph = builder.build({y});
    const bufferSize = utils.sizeOfShape(oldShape);
    const inputBuffer = new Float32Array(bufferSize);
    for (let i = 0; i < inputBuffer.length; ++i) {
      inputBuffer[i] = Math.random();
    }
    const inputs = {'x': inputBuffer};
    const outputs = {
      'y': new Float32Array(
          utils.sizeOfShape(expectedShape ? expectedShape : newShape)),
    };
    graph.compute(inputs, outputs);
    utils.checkValue(outputs.y, inputBuffer);
  }

  test(() => {
    testReshape([2, 3, 4], [4, 2, 3]);
  },'reshape reordered_all_dims');

  test(() => {
    testReshape([2, 3, 4], [2, 4, 3]);
  },'reshape reordered_last_dims');

  test(() => {
    testReshape([2, 3, 4], [2, 12]);
  },'reshape reduced_dims');

  test(() => {
    testReshape([2, 3, 4], [2, 3, 2, 2]);
  },'reshape extended_dims');

  test(() => {
    testReshape([2, 3, 4], [24]);
  },'reshape one_dim');

  test(() => {
    testReshape([2, 3, 4], [2, -1, 2], [2, 6, 2]);
  },'reshape [2, 3, 4] to negative_dim [2, -1, 2]');

  test(() => {
    testReshape([2, 3, 4], [-1, 2, 3, 4], [1, 2, 3, 4]);
  },'reshape [2, 3, 4] to negative_dim [-1, 2, 3, 4]');
</script>
